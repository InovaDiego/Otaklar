<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="
https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js
"></script>
    <link href="
https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css
" rel="stylesheet">
    <script src="https://kit.fontawesome.com/be795778ef.js" crossorigin="anonymous"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
    <title>Otaklar</title>
    <style>
        div {
            outline: none;
        }

        #cue-data {
            border: 1.9px solid black;
        }

        #notes-data {
            border-top: 1.9px solid black;
            border-right: 1.9px solid black;
            border-bottom: 1.9px solid black;
        }

        #cue-col {
            border-top: 1.9px solid black;
            border-right: 1.9px solid black;
            border-left: 1.9px solid black;
        }

        #notes-col {
            border-top: 1.9px solid black;
            border-right: 1.9px solid black;
        }

        .content div {
            padding: 1.2rem 1rem;
        }

        /* change the default border of the toolbar*/
        .ql-toolbar {
            border-top: 0 !important;
            border-left: 0 !important;
            border-right: 0 !important;
        }

        /* change the dropdown label default value*/
        .ql-picker-label[data-value="12px"]::before {
            content: "12px" !important;
        }

        .ql-picker-label[data-value="16px"]::before {
            content: "16px" !important;
        }

        .ql-picker-label[data-value="24px"]::before {
            content: "24px" !important;
        }

        .ql-picker-label[data-value="32px"]::before {
            content: "32px" !important;
        }

        /* change the dropdown items default value*/
        .ql-picker-item[data-value="12px"]::before {
            content: "12px" !important;
        }

        .ql-picker-item[data-value="16px"]::before {
            content: "16px" !important;
        }

        .ql-picker-item[data-value="24px"]::before {
            content: "24px" !important;
        }

        .ql-picker-item[data-value="32px"]::before {
            content: "32px" !important;
        }

        /* to display dynamically each toolbar based on the focus on one of the two editors */
        .hidden {
            display: none !important;
        }

        .ql-toolbar.ql-snow .ql-stroke {
            stroke: #000 !important;
        }

        .ql-picker-label::before,
        .ql-picker-item::before {
            color: #000 !important;
        }

        /* change the handler size of the image resizing */
        div[style*='height: 12px'][style*='width: 12px'] {
            padding: 4px !important;
            padding: 4px !important;
        }

        .pulse {
            animation: pulseScale 0.6s ease;
        }

        @keyframes pulseScale {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>

<body>
    <div class="d-flex align-items-center py-3 px-3 border-bottom">
        <div class="d-flex align-items-center gap-3">
            <i class="fa-solid fa-file" style="font-size: 1.6rem;"></i>
            <h4 class="mb-0" id="doc-title" contenteditable="true">Nuevo Documento</h4>
        </div>
        <div class="d-flex flex-grow-1 justify-content-end gap-3">
            <button class="btn btn-primary" id="save-btn">Guardar</button>
            <button class="btn btn-primary" id="back-btn">Dashboard</button>
        </div>
    </div>

    <div id="toolbar1" class="d-flex justify-content-center py-2 mb-3 hidden">
        <!-- Font size -->
        <select class="ql-size">
            <option value="12px"></option>
            <option value="16px"></option>
            <option value="24px"></option>
            <option value="32px"></option>
        </select>

        <!-- Bold / italic -->
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>

        <!-- Text color -->
        <select class="ql-color"></select>

        <button class="ql-align" value=""></button>
        <button class="ql-align" value="center"></button>
        <button class="ql-align" value="right"></button>
        <button class="ql-align" value="justify"></button>

        <button class="ql-indent" value="-1"></button>
        <button class="ql-indent" value="+1"></button>

        <!-- Lists -->
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>

        <!-- Links & images -->
        <button class="ql-link"></button>
        <button class="ql-image"></button>
    </div>
    <div id="toolbar2" class="d-flex justify-content-center py-2 mb-3">
        <!-- Font size -->
        <select class="ql-size">
            <option value="12px"></option>
            <option value="16px"></option>
            <option value="24px"></option>
            <option value="32px"></option>
        </select>

        <!-- Bold / italic -->
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>

        <!-- Text color -->
        <select class="ql-color"></select>

        <button class="ql-align" value=""></button>
        <button class="ql-align" value="center"></button>
        <button class="ql-align" value="right"></button>
        <button class="ql-align" value="justify"></button>

        <button class="ql-indent" value="-1"></button>
        <button class="ql-indent" value="+1"></button>

        <!-- Lists -->
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>

        <!-- Links & images -->
        <button class="ql-link"></button>
        <button class="ql-image"></button>
    </div>
    <div class="container d-flex flex-column" style="width: 65%; height: 100vh;">
        <div class="row text-center">
            <div class="col-4" id="cue-col">
                <strong>Cue</strong>
            </div>
            <div class="col-8" id="notes-col">
                <strong>Notes</strong>
            </div>
        </div>
        <div class="row flex-grow-1 content">
            <div class="col-4" id="cue-data">
            </div>
            <div class="col-8" id="notes-data">
            </div>
        </div>
    </div>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="
https://cdn.rawgit.com/kensnyder/quill-image-resize-module/3411c9a7/image-resize.min.js
"></script>
    <script src="/config.js"></script>
    <script>
        const icons = Quill.import('ui/icons');

        // Use your Font Awesome kit classes here
        icons.link = '<i class="fa-solid fa-link"></i>';
        icons.image = '<i class="fa-solid fa-image"></i>';
    </script>
    <script>
        /* set up personalized font-sizes */
        const Size = Quill.import('attributors/style/size');
        Size.whitelist = ['12px', '16px', '24px', '32px'];
        Quill.register(Size, true);

        /* the dynamic function to show the corresponding toolbar based on which editor was clicked */
        const toolbar1 = document.getElementById('toolbar1');
        const toolbar2 = document.getElementById('toolbar2');

        function showToolbar(which) {
            if (which === 1) {
                toolbar1.classList.remove('hidden');
                toolbar2.classList.add('hidden');
            } else if (which === 2) {
                toolbar2.classList.remove('hidden');
                toolbar1.classList.add('hidden');
            }
        }

        /* create the two different word processings */
        const quill1 = new Quill("#cue-data", {
            theme: "snow",
            modules: {
                toolbar: "#toolbar1",
                imageResize: {
                    displaySize: true
                }
            },
        });

        const quill2 = new Quill("#notes-data", {
            theme: "snow",
            modules: {
                toolbar: "#toolbar2",
                imageResize: {
                    displaySize: true
                }
            },
        });

        /* event listeners to know which editor was clicked: */
        quill1.on('selection-change', (range) => {
            if (range) {
                showToolbar(1);
            }
        });

        // When user focuses/selects in editor 2 â†’ show toolbar2
        quill2.on('selection-change', (range) => {
            if (range) {
                showToolbar(2);
            }
        });
    </script>
    <script>
        //This script is for uploading the contents of the front-end cornell notes template to the backend
        const API_BASE = window.BACKEND_ORIGIN;
        if (!API_BASE) {
            throw new Error('BACKEND_ORIGIN environment variable is not set');
        }
        const save = document.getElementById('save-btn');
        const backBtn = document.getElementById('back-btn');
        const docTitle = document.getElementById('doc-title');
        let documentID = null;
        let saveTimeout = null;

        function flashSaved(success = true) {
            if (!save) return;
            const originalText = save.textContent;
            const originalClass = save.className;
            save.textContent = success ? 'Guardado' : 'Error al guardar';
            save.className = `btn ${success ? 'btn-success' : 'btn-danger'}`;
            save.classList.add('pulse');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                save.textContent = 'Guardar';
                save.className = originalClass;
            }, 1500);
        }

        async function loadDocumentFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const docId = params.get('id');
            if (!docId) return;

            try {
                const res = await fetch(`${API_BASE}/api/documents/${docId}`, { credentials: 'include' });
                if (res.status === 401) {
                    window.location.href = './login.html';
                    return;
                }
                if (!res.ok) {
                    console.error('No se pudo cargar el documento');
                    return;
                }
                const data = await res.json();
                documentID = data.id;
                docTitle.textContent = data.title || 'Documento';
                quill1.setContents(data.contentA || {});
                quill2.setContents(data.contentB || {});
            } catch (err) {
                console.error(err);
            }
        }

        async function saveDocument() {
            const title = docTitle.textContent.trim() || 'Documento';
            const contentA = quill1.getContents();
            const contentB = quill2.getContents();

            const isNew = !documentID;
            const url = isNew ? `${API_BASE}/api/documents` : `${API_BASE}/api/documents/${documentID}`;
            const method = isNew ? 'POST' : 'PUT';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title,
                        contentA,
                        contentB
                    })
                });

                if (res.status === 401) {
                    window.location.href = './login.html';
                    return;
                }

                if (!res.ok) {
                    console.error('No se pudo guardar');
                    return;
                }

                const data = await res.json();
                documentID = data.id;
                console.log(isNew ? 'Documento creado' : 'Documento actualizado', data.id);
                flashSaved(true);
            } catch (err) {
                console.error(err);
                flashSaved(false);
            }
        }

        save.addEventListener('click', saveDocument);
        loadDocumentFromQuery();
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                window.location.href = './cornell-dashboard.html';
            });
        }
    </script>
    <script>
    </script>
</body>

</html>
